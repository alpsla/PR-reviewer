{% extends "base.html" %}

{% block content %}
<div class="card border-0 shadow">
    <div class="card-body p-4">
        <h4 class="mb-4 fw-bold" style="color: var(--primary-color);">Submit Pull Request</h4>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert">
                        {% if category == 'error' %}
                            <i class="fas fa-exclamation-circle me-2"></i>
                        {% elif category == 'warning' %}
                            <i class="fas fa-exclamation-triangle me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <form action="{{ url_for('review') }}" method="POST" id="prForm">
            <div class="mb-4">
                <label for="pr_url" class="form-label" style="color: var(--text-primary);">GitHub PR URL</label>
                <input type="url" 
                       class="form-control form-control-lg" 
                       id="pr_url" 
                       name="pr_url" 
                       placeholder="https://github.com/owner/repo/pull/123"
                       required>
                <div class="form-text mt-2">Enter the full URL of the GitHub pull request</div>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="analyzeBtn">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="analyzeSpinner"></span>
                <span class="button-text">Analyze PR</span>
            </button>
        </form>
    </div>
</div>

<style>
    .form-control {
        background-color: var(--card-bg);
        border: 2px solid rgba(156, 163, 175, 0.3);
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .form-control:focus {
        background-color: var(--card-bg);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        color: var(--text-primary);
    }

    .form-text {
        color: var(--text-secondary) !important;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    .btn-primary:active {
        transform: translateY(1px);
    }
    
    .alert {
        border: none;
        border-radius: 8px;
    }
    
    .alert-error {
        background-color: #FEE2E2;
        color: #991B1B;
    }
    
    .alert-warning {
        background-color: #FEF3C7;
        color: #92400E;
    }
    
    .btn-primary {
        position: relative;
        overflow: hidden;
    }
    
    .btn-primary:disabled {
        background-color: var(--primary-color);
        opacity: 0.8;
    }
    
    .spinner-border {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('prForm').addEventListener('submit', function(e) {
    const button = document.getElementById('analyzeBtn');
    const spinner = document.getElementById('analyzeSpinner');
    const buttonText = button.querySelector('.button-text');
    
    // Disable button and show spinner
    button.disabled = true;
    spinner.classList.remove('d-none');
    buttonText.textContent = 'Analyzing...';
    
    // Set a timeout to check if the analysis is taking too long
    const timeoutDuration = 30000; // 30 seconds
    const timeout = setTimeout(() => {
        // If we haven't redirected by now, show a timeout error
        button.disabled = false;
        spinner.classList.add('d-none');
        buttonText.textContent = 'Analyze PR';
        
        const alert = document.createElement('div');
        alert.className = 'alert alert-warning alert-dismissible fade show mb-4';
        alert.role = 'alert';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            The analysis is taking longer than expected. Please check your PR URL and try again.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert alert before the form
        const form = document.getElementById('prForm');
        form.parentNode.insertBefore(alert, form);
    }, timeoutDuration);
    
    // Store the timeout ID in sessionStorage so we can clear it if we successfully redirect
    sessionStorage.setItem('analysisTimeout', timeout);
});

// Clear any existing timeouts when the page loads (in case we're returning from an error)
window.addEventListener('load', function() {
    const timeout = sessionStorage.getItem('analysisTimeout');
    if (timeout) {
        clearTimeout(timeout);
        sessionStorage.removeItem('analysisTimeout');
    }
});
</script>
{% endblock %}
